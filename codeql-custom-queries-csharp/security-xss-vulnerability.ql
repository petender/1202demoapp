/**
 * @name Cross-site scripting (XSS) vulnerability
 * @description Detects potential XSS vulnerabilities where user input flows to HTML output
 *              without proper encoding or sanitization.
 * @kind path-problem
 * @problem.severity error
 * @security-severity 8.5
 * @precision high
 * @id csharp/aspnet/xss-vulnerability
 * @tags security
 *       xss
 *       cross-site-scripting
 *       external/cwe/cwe-79
 */

import csharp
import semmle.code.csharp.dataflow.TaintTracking

// Properties that can be bound from user input
class UserInputProperty extends Property {
  UserInputProperty() {
    exists(Attribute attr |
      attr = this.getAnAttribute() and
      attr.getType().hasName("BindPropertyAttribute")
    )
  }
}

// Methods that output to HTML without encoding
class HtmlOutputCall extends MethodCall {
  HtmlOutputCall() {
    // Html.Raw() calls that bypass encoding
    (this.getTarget().hasName("Raw") and
     this.getTarget().getDeclaringType().getName() = "IHtmlHelper") or
    // Direct ViewData/ViewBag assignments
    exists(PropertyAccess pa |
      pa = this.getQualifier() and
      (pa.getProperty().getName() = "ViewData" or
       pa.getProperty().getName() = "ViewBag")
    )
  }
}

module XssFlow = TaintTracking::Global<XssConfig>;

import XssFlow::PathGraph

module XssConfig implements DataFlow::ConfigSig {
  predicate isSource(DataFlow::Node source) {
    exists(UserInputProperty prop |
      source.asExpr() = prop.getAnAccess()
    )
  }

  predicate isSink(DataFlow::Node sink) {
    exists(HtmlOutputCall call |
      sink.asExpr() = call.getAnArgument()
    )
  }
}

from XssFlow::PathNode source, XssFlow::PathNode sink
where XssFlow::flowPath(source, sink)
select sink.getNode(), source, sink,
  "CRITICAL: Potential XSS vulnerability. User input from $@ flows to HTML output without proper encoding.",
  source.getNode(), "user input property"
